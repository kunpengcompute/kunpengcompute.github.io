<!DOCTYPE html>
<html  lang="en">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.2.1" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>Need for external compression methods in PostgreSQL - Kunpeng Compute Team Blog</title>


    <meta name="description" content="译者: bzhaoopenstack作者: Amit Dattatray Khandekar原文链接: https:&#x2F;&#x2F;amitdkhan-pg.blogspot.com&#x2F;2020&#x2F;08&#x2F;need-for-external-compression-methods.html 数据库中的压缩算法对DBA和后续的维护成本至关重要，PG社区上游正在讨论如何为用户提供自定义native压缩算法，包括软硬件压">
<meta property="og:type" content="article">
<meta property="og:title" content="Need for external compression methods in PostgreSQL">
<meta property="og:url" content="https://kunpengcompute.github.io/2021/07/07/need-for-external-compression-methods-in-postgresql/index.html">
<meta property="og:site_name" content="Kunpeng Compute Team Blog">
<meta property="og:description" content="译者: bzhaoopenstack作者: Amit Dattatray Khandekar原文链接: https:&#x2F;&#x2F;amitdkhan-pg.blogspot.com&#x2F;2020&#x2F;08&#x2F;need-for-external-compression-methods.html 数据库中的压缩算法对DBA和后续的维护成本至关重要，PG社区上游正在讨论如何为用户提供自定义native压缩算法，包括软硬件压">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://kunpengcompute.github.io/images/og_image.png">
<meta property="article:published_time" content="2021-07-07T08:18:06.000Z">
<meta property="article:modified_time" content="2021-07-08T02:56:40.868Z">
<meta property="article:author" content="鲲鹏计算开源生态团队">
<meta property="article:tag" content="数据库">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kunpengcompute.github.io/images/og_image.png">





<link rel="alternative" href="/atom.xml" title="Need for external compression methods in PostgreSQL" type="application/atom+xml">



<link rel="icon" href="/images/logo.png">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    <script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?5def612917161d75998e840a01d72a58";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <div style='margin:0 auto;display:none;'>
        <img src='/images/logo.png' />
    </div>
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/banner.png" alt="Need for external compression methods in PostgreSQL" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/arm-landscape">Landscape</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" rel="noopener" title="Our GitHub" href="https://github.com/kunpengcompute">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2021-07-07T08:18:06.000Z">2021-07-07</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
                </div>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Need for external compression methods in PostgreSQL
            
        </h1>
        <div class="content">
            <p>译者: bzhaoopenstack<br>作者: Amit Dattatray Khandekar<br>原文链接: <a href="https://amitdkhan-pg.blogspot.com/2020/08/need-for-external-compression-methods.html">https://amitdkhan-pg.blogspot.com/2020/08/need-for-external-compression-methods.html</a></p>
<p>数据库中的压缩算法对DBA和后续的维护成本至关重要，PG社区上游正在讨论如何为用户提供自定义native压缩算法，包括软硬件压缩，对于DB产业价值很高。</p>
<a id="more"></a>

<div class="tabs is-toggle"><ul>
<li class="is-active"><a onclick="onTabClick(event)">
<span>中文</span>
</a></li>
<li><a onclick="onTabClick(event)">
<span>English</span>
</a></li>
</ul></div>


<div id="中文" class="tab-content" style="display: block;">

<h1 id="Need-for-external-compression-methods-in-PostgreSQL"><a href="#Need-for-external-compression-methods-in-PostgreSQL" class="headerlink" title="Need for external compression methods in PostgreSQL"></a>Need for external compression methods in PostgreSQL</h1><p>现下每个数据库系统都有一些方法压缩其数据，最直白的原因是尽可能缩小数据库存储空间，缩小存储成本。尤其是在当今数据量呈指数级增长的环境下，这一功能显得很重要。另有一个比较隐式的原因是提高查询性能；思路是：较小的数据大小意味着需要扫描的数据页较少，较少的磁盘I/O和更快的数据访问。因此，如果我们不能提高查询性能，至少需要保证数据解压缩都应该足够快，不应影响查询性能。</p>
<p>来看看压缩级别有：页压缩、行压缩、列压缩等。列存数据库的优点是其列的压缩比非常高，因为列中存在重复结构的连续数据。另一种情况是，在行存数据库中，列值区间和空间非常大，以至于压缩列的单个值是有意义的。如果这些值不适合在单个页中，我们甚至可以单独保留在其他地方，并且该行具有指向行外压缩数据的指针。在PostgreSQL中，这种技术被称为TOAST（超大属性存储技术），其中，对于可以包含可变长度数据的列，数据将透明压缩并存储在同一行中，如果数据仍然太大，它将以较小的块作为行存储在一个单独表中，我们称其为toast表，在那里这些块本身可以被压缩，也可以不被压缩。</p>
<p>压缩技术可被应用于不同的目的。它不限于仅数据压缩。例如，在DB replication环境中，redo日志从主到从的传输可能会成为一个巨大的网络瓶颈，因此许多RDBMS提供压缩redo日志功能。</p>
<p>然后是RDBMS使用或供用户选择的压缩算法。这些尤其适用于数据压缩。由于数据是用户数据，用户数据中的特定模式可能适合特定的压缩算法，而不同的模式可能适合另一种压缩算法。这意味着，如果RDBMS提供一个选项，从已知标准压缩库列表中选择特定列或特定用户自定义类型的压缩算法，如zlib、lz4、ztd，或者，库算法很可能是一个基于客户业务需求完全定制的算法。</p>
<p>其次，在特定平台的压缩算法优化方面，已经取得了许多进步，并为压缩、加密和SIMD提供硬件加速器，这些加速器与CPU内核紧密耦合，然后可以通过压缩或加密算法使用这些硬件加速器。其中一个例子是<a href="https://github.com/kunpengcompute/KAEzip">鲲鹏Zlib加速引擎</a>，它提供了一个硬件使能的基础架构，用于在“鲲鹏920”ARM64处理器上进行压缩。现在我还没有机会测试这种能力，但听起来确实很有希望。</p>
<p>此外，压缩/加密算法往往对数据执行重复任务，这自然适合利用SIMD矢量化技术。ARM64和英特尔都有在zlib、lz4等知名库中进行相关特定平台的增强。查看此<a href="https://developer.arm.com/architectures/instruction-sets/simd-isas/neon/neon-programmers-guide-for-armv8-a/neon-intrinsics-chromium-case-study/adler-32">NEON Inrinsics案例研究</a>使用NEON优化zlib内部的adler-32算法。</p>
<p>以上这些都直接表明，RDBMS服务迫切需要为用户提供特定表或特定列的native压缩算法/库的选择。在撰写本文时，PostgreSQL使用<a href="https://doxygen.postgresql.org/pg__lzcompress_8c_source.html">其自己的内置压缩算法</a>基于LZ的toast表压缩。想象一下，如果有一个接口来选择zlib而不是内置算法。用户可以选择zlib压缩级别。再进一步，添加一个接口，供用户创建相关扩展，该扩展使用对于特定平台的硬件加速算法。</p>
<p>正是有这样一个proposal正在酝酿中。查看在PostgreSQL hackers Maillist中的<a href="https://www.postgresql.org/message-id/flat/CAFiTN-uUpX3ck%3DK0mLEk-G_kUQY%3DSNOTeqdaNRR9FMdQrHKebw%40mail.gmail.com#81b25677aea9423d8ebb3feebcd1af46">讨论主题</a>。这可能还有很长的路要走（在撰写本文时），但我非常希望这个功能能够进入，因为应用场景足够有说服力，如上文所述，社区对这个功能没有根本的反对意见，并且相关的开发者正在为之奋斗。</p>
<p>我提前merge了这个特性到我的环境，并尝试玩玩。下面是界面的外观。如果所有patch完全实现后，界面可能会有所不同，但我认为它的本质或多或少会保持不变。下面是我的测试输出；注意，这只是为了通过示例强调这个功能是多么的酷和有用，助于理解我在本博客中上面解释的内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE zlibtab(t TEXT COMPRESSION zlib WITH (level &#39;4&#39;));</span><br><span class="line">CREATE TABLE lztab(t TEXT);                           </span><br><span class="line">ALTER TABLE lztab ALTER COLUMN t SET COMPRESSION pglz;              </span><br><span class="line">                                         </span><br><span class="line">pgg:s2:pg$ time psql -c &quot;\copy zlibtab from text.data&quot;              </span><br><span class="line">COPY 13050                                    </span><br><span class="line">                                         </span><br><span class="line">real  0m1.344s                                 </span><br><span class="line">user  0m0.031s                                 </span><br><span class="line">sys   0m0.026s                                 </span><br><span class="line"></span><br><span class="line">pgg:s2:pg$ time psql -c &quot;\copy lztab from text.data&quot;               </span><br><span class="line">COPY 13050                                    </span><br><span class="line">                                         </span><br><span class="line">real  0m2.088s                                 </span><br><span class="line">user  0m0.008s                                 </span><br><span class="line">sys   0m0.050s                                 </span><br><span class="line">                                         </span><br><span class="line">                                         </span><br><span class="line">pgg:s2:pg$ time psql -c &quot;select pg_table_size(&#39;zlibtab&#39;::regclass), pg_table_size(&#39;lztab&#39;::regclass)&quot;</span><br><span class="line"> pg_table_size | pg_table_size                          </span><br><span class="line">---------------+---------------                         </span><br><span class="line">    1261568 |    1687552                          </span><br><span class="line"></span><br><span class="line">pgg:s2:pg$ time psql -c &quot;select NULL from zlibtab where t like &#39;0000&#39;&quot; &gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">real  0m0.127s</span><br><span class="line">user  0m0.000s</span><br><span class="line">sys   0m0.002s</span><br><span class="line"></span><br><span class="line">pgg:s2:pg$ time psql -c &quot;select NULL from lztab where t like &#39;0000&#39;&quot; &gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">real  0m0.050s</span><br><span class="line">user  0m0.002s</span><br><span class="line">sys   0m0.000s</span><br></pre></td></tr></table></figure>
<p>注意两种不同的压缩算法在压缩数据大小以及插入数据（压缩）和选择数据（解压缩）的速度方面有何不同。</p>
<p>你甚至可以使用与创建新索引相同的方式创建新的压缩访问方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE ACCESS METHOD pglz1 TYPE COMPRESSION HANDLER my_compression_handler;</span><br></pre></td></tr></table></figure>
<p>where my_compression_handler should be a PostgreSQL C function that could be created using a PostgreSQL extension. This function assigns its own implementation functions for a set of pre-defined hooks that define everything that the PostgreSQL core needs to know to make use of the compression access method :</p>
<p>其中my_compress_handler是可以使用PostgreSQL extension创建的PostgreSQL C函数。此函数为一组预定义的钩子分配自己的实现函数，这些钩子定义了PostgreSQL核心需要知道的压缩访问方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Datum</span><br><span class="line">my_compression_handler(PG_FUNCTION_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">    CompressionAmRoutine *routine &#x3D; makeNode(CompressionAmRoutine);</span><br><span class="line"></span><br><span class="line">​    routine-&gt;cmcheck &#x3D; my_cmcheck;</span><br><span class="line">​    routine-&gt;cminitstate &#x3D; my_cminitstate;</span><br><span class="line">​    routine-&gt;cmcompress &#x3D; my_cmcompress;</span><br><span class="line">​    routine-&gt;cmdecompress &#x3D; my_cmdecompress;</span><br><span class="line">​    routine-&gt;cmdecompress_slice &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">​    PG_RETURN_POINTER(routine);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is PostgreSQL’s way of being highly extensible : Allow user to use built-in methods, but also provide a way for the user to define his/her own methods for doing the same job. All the above functions would be inside an PostgreSQL extension, that could be created using:</p>
<p>这是PostgreSQL高度可扩展的方式：允许用户使用内置方法，但也为用户提供了一种方法，以自定义的方法来执行相同的工作。上述所有函数都将位于PostgreSQL扩展中，可以用下面的命令创建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE EXTENSION my_compression;</span><br></pre></td></tr></table></figure>

</div>
<div id="English" class="tab-content">

<p> Every modern database system has some way to compress its data at some level. The obvious reason for this feature is to reduce the size of it’s database, especially in today’s world where the data is growing exponentially. The less obvious reason is to improve query performance; the idea is: smaller data size means less data pages to scan, which means lesser disk i/o and faster data access. So, in any case, data de-compression should be fast enough so as not to hamper the query performance, if not improve it.</p>
<p>Compression is offered at different levels : page compression, row compression, column compression, etc. Columnar databases have the advantage of a very high compression ratio of its column because of presence of a repetetive pattern of contiguous data in a column. Another case is when, in a row oriented database, the column values are so large that it makes sense to compress individual values of the column. Such values can even be kept separately if they do not fit in a single page. And the row has pointers to the out-of-line compressed data. In PostgreSQL, such technique is called TOAST (The Oversized-Attribute Storage Technique), where, for columns that can contain variable-length data, the data is transparently compressed and stored in the same row, or else if it is still too large, it is stored in smaller chunks as rows in a separate table called a toast table, where these chunks themselves may or may not be compressed.</p>
<p>Compression is offered for different purposes. It may not be restricted for only data compression. E.g. in a replication system, the transfer of redo logs from the master to slave can become a huge network bottleneck, so many RDBMS offer to compress redo logs.</p>
<p>And then comes the compression algorithms that the RDBMS uses or gives options to choose. This applies especially more to data compression. Since data is user’s data, a specific pattern in the user data might suit a particular compression algorithm, while a different pattern might be suitable for another compression algorithm. Moreover, this implies that it would be far more beneficial if the RDBMS gives an option to choose a specific compression algorithm for a specific column or a specific user-defined type out of a list of well-known standard compression libraries such as zlib, lz4, ztd, snappy, gzip, etc. Or, the library algorithm may very well be a completely customized one.</p>
<p>Secondly, there has been a lot of advancements to optimize compression algorithms for specific platforms, and provide hardware accelerators for Compression, Encryption and SIMD that are closely coupled to CPU cores, which can then be levergaed by compression or encryption algorithms. One such example is the <a href="https://github.com/kunpengcompute/KAEzip">Kunpeng Zlib Acceleration Engine</a>, which offers a hardware-enabled infrastructure for compression on a “Kunpeng 920” ARM64 processor. I haven’t got a chance to test this capability, but it does sound promising.</p>
<p>Furthermore, the compression/encryption algorithms inherently do repetitive tasks over the data, which is a natural fit for leveraging SIMD vectorization. There has been independent projects going on on both ARM64 and Intel to do such platform-specific enhancements in well known libraries like zlib, lz4 etc. Check out this <a href="https://developer.arm.com/architectures/instruction-sets/simd-isas/neon/neon-programmers-guide-for-armv8-a/neon-intrinsics-chromium-case-study/adler-32">NEON Intrinsics case study</a> that optimizes zlib’s adler-32 algorithm using NEON intrinsics.</p>
<p>All this directly points to an urgent need for RDBMS servers to give users a choice for specific native compression algorithms/libraries for specific tables or specific columns. As of this writing, PostgreSQL uses <a href="https://doxygen.postgresql.org/pg__lzcompress_8c_source.html">its own built-in compression algorithm</a> based on LZ for toast table compression. Imagine if there were an interface to select zlib instead of the built-in algorithm. Further, select the zlib compression level. Still further, add an interface for users to create an extension that uses a customized algorithm native to a specific platform that uses hardware acceleration.</p>
<p>Well, there is exactly such a proposed feature in the making. Check out this <a href="https://www.postgresql.org/message-id/flat/CAFiTN-uUpX3ck%3DK0mLEk-G_kUQY%3DSNOTeqdaNRR9FMdQrHKebw%40mail.gmail.com#81b25677aea9423d8ebb3feebcd1af46">discussion thread</a> in the PostgreSQL hackers community. It may be a long way to go (as of this writing), but I am very hopeful of this feature going in, because the use-cases are strong enough as shown above, there are no fundamental objections to this functionality, and there are work-in-progress patches submitted.</p>
<p>I went ahead and applied this patch, and played around it. Roughly, below is how the interface looks like. After the patch-set fully materializes, the interface might be different, but I think the essence of it would remain more or less the same. Below is the output of my tests; please note that it is just to emphasize with examples how cool and useful this feature would be, and to make sense of whatever I explained above in this blog.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE zlibtab(t TEXT COMPRESSION zlib WITH (level &#39;4&#39;));</span><br><span class="line">CREATE TABLE lztab(t TEXT);                           </span><br><span class="line">ALTER TABLE lztab ALTER COLUMN t SET COMPRESSION pglz;              </span><br><span class="line">                                         </span><br><span class="line">pgg:s2:pg$ time psql -c &quot;\copy zlibtab from text.data&quot;              </span><br><span class="line">COPY 13050                                    </span><br><span class="line">                                         </span><br><span class="line">real  0m1.344s                                 </span><br><span class="line">user  0m0.031s                                 </span><br><span class="line">sys   0m0.026s                                 </span><br><span class="line"></span><br><span class="line">pgg:s2:pg$ time psql -c &quot;\copy lztab from text.data&quot;               </span><br><span class="line">COPY 13050                                    </span><br><span class="line">                                         </span><br><span class="line">real  0m2.088s                                 </span><br><span class="line">user  0m0.008s                                 </span><br><span class="line">sys   0m0.050s                                 </span><br><span class="line">                                         </span><br><span class="line">                                         </span><br><span class="line">pgg:s2:pg$ time psql -c &quot;select pg_table_size(&#39;zlibtab&#39;::regclass), pg_table_size(&#39;lztab&#39;::regclass)&quot;</span><br><span class="line"> pg_table_size | pg_table_size                          </span><br><span class="line">---------------+---------------                         </span><br><span class="line">    1261568 |    1687552                          </span><br><span class="line"></span><br><span class="line">pgg:s2:pg$ time psql -c &quot;select NULL from zlibtab where t like &#39;0000&#39;&quot; &gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">real  0m0.127s</span><br><span class="line">user  0m0.000s</span><br><span class="line">sys   0m0.002s</span><br><span class="line"></span><br><span class="line">pgg:s2:pg$ time psql -c &quot;select NULL from lztab where t like &#39;0000&#39;&quot; &gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">real  0m0.050s</span><br><span class="line">user  0m0.002s</span><br><span class="line">sys   0m0.000s</span><br></pre></td></tr></table></figure>
<p>Notice how two different compression algorithms differ in the compressed size, and the speed of inserting data (compression) and selecting data (decompression).</p>
<p>You would even be able to create a new compression access method using the same way as we do for creating a new index :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE ACCESS METHOD pglz1 TYPE COMPRESSION HANDLER my_compression_handler;</span><br></pre></td></tr></table></figure>
<p>where my_compression_handler should be a PostgreSQL C function that could be created using a PostgreSQL extension. This function assigns its own implementation functions for a set of pre-defined hooks that define everything that the PostgreSQL core needs to know to make use of the compression access method :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Datum</span><br><span class="line">my_compression_handler(PG_FUNCTION_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">    CompressionAmRoutine *routine &#x3D; makeNode(CompressionAmRoutine);</span><br><span class="line"></span><br><span class="line">​    routine-&gt;cmcheck &#x3D; my_cmcheck;</span><br><span class="line">​    routine-&gt;cminitstate &#x3D; my_cminitstate;</span><br><span class="line">​    routine-&gt;cmcompress &#x3D; my_cmcompress;</span><br><span class="line">​    routine-&gt;cmdecompress &#x3D; my_cmdecompress;</span><br><span class="line">​    routine-&gt;cmdecompress_slice &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">​    PG_RETURN_POINTER(routine);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is PostgreSQL’s way of being highly extensible : Allow user to use built-in methods, but also provide a way for the user to define his/her own methods for doing the same job. All the above functions would be inside an PostgreSQL extension, that could be created using:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE EXTENSION my_compression;</span><br></pre></td></tr></table></figure>

</div>

<style type="text/css">
.content .tabs ul { margin: 0; }
.content .tabs ul li { margin: 0; }
.tab-content { display: none; }
</style>


<script>
function onTabClick (event) {
    var tabTitle = $(event.currentTarget).children('span:last-child').text();
    $('.article .content .tab-content').css('display', 'none');
    $('.article .content .tabs li').removeClass('is-active');
    $('#' + tabTitle).css('display', 'block');
    $(event.currentTarget).parent().addClass('is-active');
}
</script>
        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2021/07/08/a-quick-sanity-testing-of-postgresql-parallel-query-on-arm64/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">A quick sanity testing of PostgreSQL parallel query on Arm64</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2020/12/23/hao-wai-hao-wai-mdb-ren-ke-liao-huawei-zai-she-qu-shang-you-de-xing-neng-you-hua/">
                <span class="level-item">号外号外，MDB认可了Huawei在社区上游的性能优化</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">Comments</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: '77c4b9cab07e89404cc4',
        clientSecret: '350dad6204f4803d3109cc9b73331eea0e7350ad',
        number: 76,
        repo: 'kunpengcompute.github.io',
        owner: 'kunpengcompute',
        admin: "Yikun",
        createIssueManually: false,
        distractionFreeMode: false
    })
    gitalk.render('comment-container')
</script>


    </div>
</div>

</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                    <figure class="image is-128x128 has-mb-6">
                        <img class="" src="/images/logo.png" alt="鲲鹏展翅，力算未来">
                    </figure>
                    
                    <p class="is-size-4 is-block">
                        鲲鹏展翅，力算未来
                    </p>
                    
                    
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Posts
                    </p>
                    <a href="/archives">
                        <p class="title has-text-weight-normal">
                            62
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Categories
                    </p>
                    <a href="/categories">
                        <p class="title has-text-weight-normal">
                            5
                        </p>
                    </a>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Tags
                    </p>
                    <a href="/tags">
                        <p class="title has-text-weight-normal">
                            8
                        </p>
                    </a>
                </div>
            </div>
        </nav>
        
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/kunpengcompute" target="_blank" rel="noopener">
                Follow</a>
        </div>
        
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="Github" href="https://github.com/kunpengcompute">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" rel="noopener"
                title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
    
        
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            Links
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://join.slack.com/t/armserverecosystem/shared_invite/enQtOTE0MDMxOTc0MTY0LTBiMTdkZWFhMjZmYzI2ZWVmYWUxMTU1YTcxY2NlZWViOGM5YTY4YzkwZDU3M2ZiZWUxMDQzMmU0NGY5YmFiYWY" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">Slack</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">join.slack.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://kunpengcompute.github.io/2020/03/27/kun-peng-ji-suan-tuan-dui-bo-ke-kai-zhang-la-huan-ying-tou-gao/" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">欢迎投稿</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">kunpengcompute.github.io</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://github.com/kunpengcompute" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">鲲鹏Github主页</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">github.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://huaweicloud.com/kunpeng" target="_blank" rel="noopener">
                    <span class="level-left">
                        <span class="level-item">华为鲲鹏社区</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">huaweicloud.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
            
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Web/">
            <span class="level-start">
                <span class="level-item">Web</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E5%9F%BA%E7%A1%80%E5%BA%93/">
            <span class="level-start">
                <span class="level-item">基础库</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">
            <span class="level-start">
                <span class="level-item">大数据</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">
            <span class="level-start">
                <span class="level-item">数据库</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">43</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/">
            <span class="level-start">
                <span class="level-item">虚拟化</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Packaging/">
                        <span class="tag">Packaging</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Web/">
                        <span class="tag">Web</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BC%9A%E8%AE%AE/">
                        <span class="tag">会议</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%9F%BA%E7%A1%80%E5%BA%93/">
                        <span class="tag">基础库</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">
                        <span class="tag">大数据</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">42</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">
                        <span class="tag">虚拟化</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                




<div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right ">
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Web/">
            <span class="level-start">
                <span class="level-item">Web</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">4</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E5%9F%BA%E7%A1%80%E5%BA%93/">
            <span class="level-start">
                <span class="level-item">基础库</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">8</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">
            <span class="level-start">
                <span class="level-item">大数据</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">
            <span class="level-start">
                <span class="level-item">数据库</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">43</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/">
            <span class="level-start">
                <span class="level-item">虚拟化</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">3</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Tags
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Java/">
                        <span class="tag">Java</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Packaging/">
                        <span class="tag">Packaging</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Web/">
                        <span class="tag">Web</span>
                        <span class="tag is-grey">4</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E4%BC%9A%E8%AE%AE/">
                        <span class="tag">会议</span>
                        <span class="tag is-grey">1</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%9F%BA%E7%A1%80%E5%BA%93/">
                        <span class="tag">基础库</span>
                        <span class="tag is-grey">6</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">
                        <span class="tag">大数据</span>
                        <span class="tag is-grey">2</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <span class="tag">数据库</span>
                        <span class="tag is-grey">42</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">
                        <span class="tag">虚拟化</span>
                        <span class="tag is-grey">3</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
    
    
</div>

            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/banner.png" alt="Need for external compression methods in PostgreSQL" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2021 鲲鹏计算开源生态团队&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" rel="noopener" title="Our GitHub" href="https://github.com/kunpengcompute">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


<script>
var IcarusThemeSettings = {
    site: {
        url: 'https://kunpengcompute.github.io',
        external_link: {"enable":true,"exclude":[]}
    },
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


<script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>





<script src="/js/animation.js"></script>



<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>



<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>





<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>














<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>
